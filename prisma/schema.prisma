datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

/**
 * ---------------- USER ----------------
 */

model User {
  id           Int     @id @default(autoincrement())
  fullname     String
  username     String  @unique
  referralCode String  @unique
  mobile       String  @unique
  email        String? @unique
  password     String
  txnPassword  String

  referredBy Int?
  parent     User?  @relation("UserParent", fields: [referredBy], references: [id])
  children   User[] @relation("UserParent")

  isActive    Boolean @default(false)
  isBlocked   Boolean @default(false)
  isSuspended Boolean @default(false)

  createdAt DateTime @default(now())

  deposits          Deposit[]
  withdraws         Withdraw[]
  wallet            Wallet?
  depositHistory    DepositHistory[]
  approvedDeposits  ApprovedDeposit[]
  rejectedDeposits  RejectedDeposit[]
  approvedWithdraws ApprovedWithdraw[]
  rejectedWithdraws RejectedWithdraw[]

  // ROI
  roiEarnings     RoiEarning[]
  roiHistory      RoiHistory[]
  userDepositRois UserDepositRoi[]

  // ROI Level Income Relations
  roiLevelIncomeReceived  RoiLevelIncome[] @relation("LevelUser")
  roiLevelIncomeGenerated RoiLevelIncome[] @relation("LevelFromUser")

  // REFERRAL COMMISSION RELATIONS
  referralCommissionsReceived ReferralCommissionHistory[] @relation("ReferralToUser")
  referralCommissionsGiven    ReferralCommissionHistory[] @relation("ReferralFromUser")
  statusHistory UserStatusHistory[]
}
model UserStatusHistory {
  id        Int      @id @default(autoincrement())
  userId    Int
  status    String   // "active" | "inactive"
  startDate DateTime @default(now())
  endDate   DateTime?
  reason    String?
  closedAt  DateTime?
  createdAt DateTime @default(now())
  user User @relation(fields: [userId], references: [id])
}



/**
 * ---------------- WALLET ----------------
 */

model Wallet {
  id     Int  @id @default(autoincrement())
  userId Int  @unique
  user   User @relation(fields: [userId], references: [id])

  mainWallet     Float @default(0)
  roiWallet      Float @default(0)
  referralWallet Float @default(0)
  levelWallet    Float @default(0)
  returnWallet   Float @default(0)
  salaryWallet   Float @default(0)
  donationWallet Float @default(0)
}

/**
 * ---------------- DEPOSIT ----------------
 */

model Deposit {
  id        Int      @id @default(autoincrement())
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
  amount    Float
  trxId     String
  status    String   @default("pending")
  createdAt DateTime @default(now())

  history                   DepositHistory[]
  userDepositRois           UserDepositRoi[]
  roiEarnings               RoiEarning[]
  referralCommissionHistory ReferralCommissionHistory[]
}

/**
 * ---------------- ADMIN PROCESS ----------------
 */

model DepositHistory {
  id          Int      @id @default(autoincrement())
  userId      Int
  depositId   Int
  amount      Float
  trxId       String
  status      String
  processedBy Int
  createdAt   DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id])
  deposit Deposit @relation(fields: [depositId], references: [id])
  admin   Admin   @relation("AdminProcessRelation", fields: [processedBy], references: [id])
}

model Admin {
  id        Int      @id @default(autoincrement())
  username  String   @unique
  password  String
  createdAt DateTime @default(now())

  processed DepositHistory[] @relation("AdminProcessRelation")
}

/**
 * ---------------- APPROVED / REJECTED ----------------
 */

model ApprovedDeposit {
  id        Int      @id @default(autoincrement())
  userId    Int
  amount    Float
  trxId     String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}

model RejectedDeposit {
  id        Int      @id @default(autoincrement())
  userId    Int
  amount    Float
  trxId     String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}

/**
 * ---------------- WITHDRAW ----------------
 */

model Withdraw {
  id         Int      @id @default(autoincrement())
  userId     Int
  user       User     @relation(fields: [userId], references: [id])
  amount     Float
  walletType String
  status     String   @default("pending")
  createdAt  DateTime @default(now())
}

model ApprovedWithdraw {
  id         Int      @id @default(autoincrement())
  userId     Int
  amount     Float
  walletType String
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}

model RejectedWithdraw {
  id         Int      @id @default(autoincrement())
  userId     Int
  amount     Float
  walletType String
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}

/**
 * ---------------- ROI MODELS ----------------
 */

model UserDepositRoi {
  id          Int      @id @default(autoincrement())
  userId      Int
  depositId   Int
  amount      Float
  roiPercent  Float    @default(2)
  nextRoiTime DateTime
  active      Boolean  @default(true)

  user    User    @relation(fields: [userId], references: [id])
  deposit Deposit @relation(fields: [depositId], references: [id])
}

model RoiHistory {
  id        Int      @id @default(autoincrement())
  userId    Int
  earningId Int
  amount    Float
  createdAt DateTime @default(now())

  user    User       @relation(fields: [userId], references: [id])
  earning RoiEarning @relation(fields: [earningId], references: [id])
}

model RoiEarning {
  id        Int      @id @default(autoincrement())
  userId    Int
  depositId Int
  amount    Float
  createdAt DateTime @default(now())

  nextRun     DateTime
  totalEarned Float     @default(0)
  maxEarnable Float     @default(0)
  isActive    Boolean   @default(true)
  lastRunDate DateTime?

  user    User    @relation(fields: [userId], references: [id])
  deposit Deposit @relation(fields: [depositId], references: [id])

  roiHistories RoiHistory[]

  @@map("roiearning")
}

model RoiSettings {
  id            Int      @id @default(autoincrement())
  roiPercent    Float    @default(2)
  capMultiplier Float    @default(2)
  roiDays       String   @default("Mon,Tue,Wed,Thu,Fri")
  offDays       String   @default("Sat,Sun")
  timezone      String   @default("UTC")
  updatedAt     DateTime @updatedAt
}

model RoiLevelIncome {
  id         Int      @id @default(autoincrement())
  userId     Int
  fromUserId Int
  level      Int
  amount     Float
  createdAt  DateTime @default(now())

  user     User @relation("LevelUser", fields: [userId], references: [id])
  fromUser User @relation("LevelFromUser", fields: [fromUserId], references: [id])
}

/**
 * ---------------- REFERRAL COMMISSION HISTORY ----------------
 */

model ReferralCommissionHistory {
  id         Int      @id @default(autoincrement())
  userId     Int
  fromUserId Int
  depositId  Int
  level      Int
  commission Float
  createdAt  DateTime @default(now())

  user     User    @relation("ReferralToUser", fields: [userId], references: [id])
  fromUser User    @relation("ReferralFromUser", fields: [fromUserId], references: [id])
  deposit  Deposit @relation(fields: [depositId], references: [id])
}
