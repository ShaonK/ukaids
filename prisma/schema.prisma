datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

/**
 * ---------------- USER ----------------
 */

model User {
  id           Int     @id @default(autoincrement())
  fullname     String
  username     String  @unique
  referralCode String  @unique
  mobile       String  @unique
  email        String? @unique
  password     String
  txnPassword  String

  referredBy Int?
  parent     User?  @relation("UserParent", fields: [referredBy], references: [id])
  children   User[] @relation("UserParent")

  isActive    Boolean @default(false)
  isBlocked   Boolean @default(false)
  isSuspended Boolean @default(false)

  createdAt DateTime @default(now())

  deposits          Deposit[]
  wallet            Wallet?
  depositHistory    DepositHistory[]
  approvedDeposits  ApprovedDeposit[]
  rejectedDeposits  RejectedDeposit[]
  approvedWithdraws ApprovedWithdraw[]
  rejectedWithdraws RejectedWithdraw[]

  // ROI
  roiEarnings     RoiEarning[]
  roiHistory      RoiHistory[]
  userDepositRois UserDepositRoi[]

  // ROI Level Income Relations
  roiLevelIncomeReceived  RoiLevelIncome[] @relation("LevelUser")
  roiLevelIncomeGenerated RoiLevelIncome[] @relation("LevelFromUser")

  // REFERRAL COMMISSION RELATIONS
  referralCommissionsReceived ReferralCommissionHistory[] @relation("ReferralToUser")
  referralCommissionsGiven    ReferralCommissionHistory[] @relation("ReferralFromUser")

  statusHistory UserStatusHistory[]

  // NEW
  userPackages       UserPackage[]
  walletTransactions WalletTransaction[]
  sentTransfers      BalanceTransfer[]   @relation("Sender")
  receivedTransfers  BalanceTransfer[]   @relation("Receiver")
  withdrawAddress  WithdrawAddress? @relation("UserWithdrawAddress")
  withdrawRequests WithdrawRequest[]
  withdraws        Withdraw[]
  
}

model UserStatusHistory {
  id        Int       @id @default(autoincrement())
  userId    Int
  status    String
  startDate DateTime  @default(now())
  endDate   DateTime?
  reason    String?
  closedAt  DateTime?
  createdAt DateTime  @default(now())

  user User @relation(fields: [userId], references: [id])
}

/**
 * ---------------- WALLET ----------------
 */

model Wallet {
  id     Int  @id @default(autoincrement())
  userId Int  @unique
  user   User @relation(fields: [userId], references: [id])

  mainWallet     Float @default(0)
  depositWallet  Float @default(0) // ðŸ”¥ NEW
  roiWallet      Float @default(0)
  referralWallet Float @default(0)
  levelWallet    Float @default(0)
  returnWallet   Float @default(0)
  salaryWallet   Float @default(0)
  donationWallet Float @default(0)
}

/**
 * ---------------- WALLET TRANSACTION (AUDIT) ----------------
 */

model WalletTransaction {
  id     Int @id @default(autoincrement())
  userId Int

  walletType String // ACCOUNT | DEPOSIT | ROI | LEVEL | REFERRAL | RETURN
  direction  String // CREDIT | DEBIT
  amount     Float

  balanceBefore Float
  balanceAfter  Float

  source      String // deposit | withdraw | transfer | roi | level | admin
  referenceId Int?
  note        String?

  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}

/**
 * ---------------- PACKAGE SYSTEM ----------------
 */

model Package {
  id        Int      @id @default(autoincrement())
  name      String
  amount    Float
  position  Int
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())

  userPackages     UserPackage[]
  balanceTransfers BalanceTransfer[] // ðŸ”¥ REQUIRED
}

model UserPackage {
  id        Int   @id @default(autoincrement())
  userId    Int
  packageId Int
  amount    Float

  isActive  Boolean   @default(true)
  startedAt DateTime  @default(now())
  endedAt   DateTime?

  source String // self | transfer | admin

  user        User      @relation(fields: [userId], references: [id])
  package     Package   @relation(fields: [packageId], references: [id])
  totalEarned Float     @default(0)
  lastRoiAt   DateTime?

  @@index([userId, isActive])
}

/**
 * ---------------- DEPOSIT ----------------
 */

model Deposit {
  id        Int      @id @default(autoincrement())
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
  amount    Float
  trxId     String
  status    String   @default("pending")
  createdAt DateTime @default(now())

  history                   DepositHistory[]
  userDepositRois           UserDepositRoi[]
  roiEarnings               RoiEarning[]
  referralCommissionHistory ReferralCommissionHistory[]
}

/**
 * ---------------- ADMIN PROCESS ----------------
 */

model DepositHistory {
  id          Int      @id @default(autoincrement())
  userId      Int
  depositId   Int
  amount      Float
  trxId       String
  status      String
  processedBy Int
  createdAt   DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id])
  deposit Deposit @relation(fields: [depositId], references: [id])
  admin   Admin   @relation("AdminProcessRelation", fields: [processedBy], references: [id])
}

model Admin {
  id        Int      @id @default(autoincrement())
  username  String   @unique
  password  String
  createdAt DateTime @default(now())

  processed DepositHistory[] @relation("AdminProcessRelation")
}

/**
 * ---------------- APPROVED / REJECTED ----------------
 */

model ApprovedDeposit {
  id        Int      @id @default(autoincrement())
  userId    Int
  amount    Float
  trxId     String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}

model RejectedDeposit {
  id        Int      @id @default(autoincrement())
  userId    Int
  amount    Float
  trxId     String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}

/**
 * ---------------- WITHDRAW ----------------
 */

model WithdrawRequest {
  id         Int      @id @default(autoincrement())
  userId     Int

  amount     Float    // requested amount (gross)
  commission Float    @default(0)
  netAmount  Float    @default(0)

  address    String
  network    String

  status     String   // pending | approved | rejected
  approvedAt DateTime?
  rejectedAt DateTime?

  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])

  @@index([status])
}

model Withdraw {
  id         Int      @id @default(autoincrement())
  userId     Int
  amount     Float
  walletType String
  status     String   @default("pending")

  createdAt  DateTime @default(now())
  approvedAt DateTime?
  rejectedAt DateTime?

  user User @relation(fields: [userId], references: [id])
}


model WithdrawAddress {
  id        Int      @id @default(autoincrement())
  userId    Int      @unique
  address   String
  network   String
  createdAt DateTime @default(now())

  user User @relation("UserWithdrawAddress", fields: [userId], references: [id])
}

model ApprovedWithdraw {
  id         Int      @id @default(autoincrement())
  userId     Int
  amount     Float
  walletType String
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}

model RejectedWithdraw {
  id         Int      @id @default(autoincrement())
  userId     Int
  amount     Float
  walletType String
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}

/**
 * ---------------- USER TO USER TRANSFER ----------------
 */

model BalanceTransfer {
  id         Int      @id @default(autoincrement())
  senderId   Int
  receiverId Int
  amount     Float
  packageId  Int?
  status     String   @default("PENDING") // âœ… NEW
  createdAt  DateTime @default(now())

  sender   User     @relation("Sender", fields: [senderId], references: [id])
  receiver User     @relation("Receiver", fields: [receiverId], references: [id])
  package  Package? @relation(fields: [packageId], references: [id])
}

/**
 * ---------------- ROI MODELS (UNCHANGED) ----------------
 */

model UserDepositRoi {
  id          Int      @id @default(autoincrement())
  userId      Int
  depositId   Int
  amount      Float
  roiPercent  Float    @default(2)
  nextRoiTime DateTime
  active      Boolean  @default(true)

  user    User    @relation(fields: [userId], references: [id])
  deposit Deposit @relation(fields: [depositId], references: [id])
}

model RoiHistory {
  id        Int      @id @default(autoincrement())
  userId    Int
  earningId Int? // ðŸ”¥ optional (important)
  amount    Float
  createdAt DateTime @default(now())

  user    User        @relation(fields: [userId], references: [id])
  earning RoiEarning? @relation(fields: [earningId], references: [id])

  // âœ… ADD THIS LINE
  levelIncomes RoiLevelIncome[]
}

model RoiEarning {
  id        Int      @id @default(autoincrement())
  userId    Int
  depositId Int
  amount    Float
  createdAt DateTime @default(now())

  nextRun     DateTime
  totalEarned Float     @default(0)
  maxEarnable Float     @default(0)
  isActive    Boolean   @default(true)
  lastRunDate DateTime?

  user         User         @relation(fields: [userId], references: [id])
  deposit      Deposit      @relation(fields: [depositId], references: [id])
  roiHistories RoiHistory[]

  @@map("roiearning")
}

model RoiSettings {
  id            Int      @id @default(autoincrement())
  roiPercent    Float    @default(2)
  capMultiplier Float    @default(2)
  roiDays       String   @default("Mon,Tue,Wed,Thu,Fri")
  offDays       String   @default("Sat,Sun")
  timezone      String   @default("UTC")
  updatedAt     DateTime @updatedAt
}

model RoiLevelIncome {
  id           Int      @id @default(autoincrement())
  userId       Int
  fromUserId   Int
  roiHistoryId Int?
  source       String?
  level        Int
  amount       Float
  createdAt    DateTime @default(now())

  user       User        @relation("LevelUser", fields: [userId], references: [id])
  fromUser   User        @relation("LevelFromUser", fields: [fromUserId], references: [id])
  roiHistory RoiHistory? @relation(fields: [roiHistoryId], references: [id])
}

/**
 * ---------------- REFERRAL COMMISSION HISTORY ----------------
 */

model ReferralCommissionHistory {
  id Int @id @default(autoincrement())

  userId     Int
  fromUserId Int
  depositId  Int?

  level      Int
  commission Decimal @db.Decimal(18, 6)

  user     User     @relation("ReferralToUser", fields: [userId], references: [id])
  fromUser User     @relation("ReferralFromUser", fields: [fromUserId], references: [id])
  deposit  Deposit? @relation(fields: [depositId], references: [id])

  createdAt DateTime @default(now())
}
