datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

/**
 * ---------------- USER ----------------
 */

model User {
  id           Int     @id @default(autoincrement())
  fullname     String
  username     String  @unique
  referralCode String
  mobile       String
  email        String?
  password     String
  txnPassword  String

  referredBy Int?
  parent     User?  @relation("UserParent", fields: [referredBy], references: [id])
  children   User[] @relation("UserParent")

  isActive    Boolean @default(false)
  isBlocked   Boolean @default(false)
  isSuspended Boolean @default(false)

  createdAt DateTime @default(now())

  deposits          Deposit[]
  withdraws         Withdraw[]
  wallet            Wallet?
  depositHistory    DepositHistory[]
  approvedDeposits  ApprovedDeposit[]
  rejectedDeposits  RejectedDeposit[]
  approvedWithdraws ApprovedWithdraw[]
  rejectedWithdraws RejectedWithdraw[]
  roiEarnings       RoiEarning[]
  roiHistory        RoiHistory[]
  userDepositRois   UserDepositRoi[]
}

/**
 * ---------------- WALLET ----------------
 */

model Wallet {
  id     Int  @id @default(autoincrement())
  userId Int  @unique
  user   User @relation(fields: [userId], references: [id])

  mainWallet     Float @default(0)
  roiWallet      Float @default(0)
  referralWallet Float @default(0)
  levelWallet    Float @default(0)
  returnWallet   Float @default(0)
  salaryWallet   Float @default(0)
  donationWallet Float @default(0)
}

/**
 * ---------------- DEPOSIT ----------------
 */

model Deposit {
  id        Int      @id @default(autoincrement())
  userId    Int
  user      User     @relation(fields: [userId], references: [id])
  amount    Float
  trxId     String
  status    String   @default("pending")
  createdAt DateTime @default(now())

  history         DepositHistory[]
  userDepositRois UserDepositRoi[]
  roiEarnings     RoiEarning[]
}

/**
 * ---------------- ADMIN PROCESS RECORDS ----------------
 */

model DepositHistory {
  id          Int      @id @default(autoincrement())
  userId      Int
  depositId   Int
  amount      Float
  trxId       String
  status      String
  processedBy Int
  createdAt   DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id])
  deposit Deposit @relation(fields: [depositId], references: [id])
  admin   Admin   @relation("AdminProcessRelation", fields: [processedBy], references: [id])
}

model Admin {
  id        Int      @id @default(autoincrement())
  username  String   @unique
  password  String
  createdAt DateTime @default(now())

  processed DepositHistory[] @relation("AdminProcessRelation")
}

/**
 * ---------------- APPROVED / REJECTED ----------------
 */

model ApprovedDeposit {
  id        Int      @id @default(autoincrement())
  userId    Int
  amount    Float
  trxId     String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}

model RejectedDeposit {
  id        Int      @id @default(autoincrement())
  userId    Int
  amount    Float
  trxId     String
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}

model Withdraw {
  id         Int      @id @default(autoincrement())
  userId     Int
  user       User     @relation(fields: [userId], references: [id])
  amount     Float
  walletType String
  status     String   @default("pending")
  createdAt  DateTime @default(now())
}

model ApprovedWithdraw {
  id         Int      @id @default(autoincrement())
  userId     Int
  amount     Float
  walletType String
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}

model RejectedWithdraw {
  id         Int      @id @default(autoincrement())
  userId     Int
  amount     Float
  walletType String
  createdAt  DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}

/**
 * ---------------- ROI MODELS ----------------
 */

model UserDepositRoi {
  id          Int      @id @default(autoincrement())
  userId      Int
  depositId   Int
  amount      Float
  roiPercent  Float    @default(2)
  nextRoiTime DateTime
  active      Boolean  @default(true)

  user    User    @relation(fields: [userId], references: [id])
  deposit Deposit @relation(fields: [depositId], references: [id])
}

model RoiHistory {
  id        Int      @id @default(autoincrement())
  userId    Int
  earningId Int
  amount    Float
  createdAt DateTime @default(now())

  user    User       @relation(fields: [userId], references: [id])
  earning RoiEarning @relation(fields: [earningId], references: [id])
}

model RoiEarning {
  id        Int      @id @default(autoincrement())
  userId    Int
  depositId Int
  amount    Float // ROI per cycle (2%)
  createdAt DateTime @default(now())

  nextRun     DateTime
  totalEarned Float    @default(0)
  maxEarnable Float  @default(0)   // âœ… FIXED default added
  isActive    Boolean  @default(true)

  user         User         @relation(fields: [userId], references: [id])
  deposit      Deposit      @relation(fields: [depositId], references: [id])
  @@map("roiearning")
  roiHistories RoiHistory[]
}
