generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                          Int                         @id @default(autoincrement())
  fullname                    String
  username                    String                      @unique
  referralCode                String                      @unique
  mobile                      String                      @unique
  email                       String?                     @unique
  password                    String
  txnPassword                 String
  referredBy                  Int?
  isActive                    Boolean                     @default(false)
  isBlocked                   Boolean                     @default(false)
  isSuspended                 Boolean                     @default(false)
  createdAt                   DateTime                    @default(now())
  approvedDeposits            ApprovedDeposit[]
  approvedWithdraws           ApprovedWithdraw[]
  receivedTransfers           BalanceTransfer[]           @relation("Receiver")
  sentTransfers               BalanceTransfer[]           @relation("Sender")
  deposits                    Deposit[]
  depositHistory              DepositHistory[]
  referralCommissionsGiven    ReferralCommissionHistory[] @relation("ReferralFromUser")
  referralCommissionsReceived ReferralCommissionHistory[] @relation("ReferralToUser")
  rejectedDeposits            RejectedDeposit[]
  rejectedWithdraws           RejectedWithdraw[]
  roiHistory                  RoiHistory[]
  roiLevelIncomeGenerated     RoiLevelIncome[]            @relation("LevelFromUser")
  roiLevelIncomeReceived      RoiLevelIncome[]            @relation("LevelUser")
  parent                      User?                       @relation("UserParent", fields: [referredBy], references: [id])
  children                    User[]                      @relation("UserParent")
  userDepositRois             UserDepositRoi[]
  userPackages                UserPackage[]
  statusHistory               UserStatusHistory[]
  wallet                      Wallet?
  walletTransactions          WalletTransaction[]
  withdraws                   Withdraw[]
  withdrawAddress             WithdrawAddress?            @relation("UserWithdrawAddress")
  withdrawRequests            WithdrawRequest[]
  roiEarnings                 RoiEarning[]

  @@index([referredBy])
}

model UserStatusHistory {
  id        Int       @id @default(autoincrement())
  userId    Int
  status    String
  startDate DateTime  @default(now())
  endDate   DateTime?
  reason    String?
  closedAt  DateTime?
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id])
}

model Wallet {
  id             Int     @id @default(autoincrement())
  userId         Int     @unique
  mainWallet     Decimal @default(0) @db.Decimal(18, 6)
  depositWallet  Decimal @default(0) @db.Decimal(18, 6)
  roiWallet      Decimal @default(0) @db.Decimal(18, 6)
  referralWallet Decimal @default(0) @db.Decimal(18, 6)
  levelWallet    Decimal @default(0) @db.Decimal(18, 6)
  returnWallet   Decimal @default(0) @db.Decimal(18, 6)
  salaryWallet   Decimal @default(0) @db.Decimal(18, 6)
  donationWallet Decimal @default(0) @db.Decimal(18, 6)
  user           User    @relation(fields: [userId], references: [id])
}

model WalletTransaction {
  id            Int      @id @default(autoincrement())
  userId        Int
  walletType    String
  direction     String
  amount        Decimal  @db.Decimal(18, 6)
  balanceBefore Decimal  @db.Decimal(18, 6)
  balanceAfter  Decimal  @db.Decimal(18, 6)
  source        String
  referenceId   Int?
  note          String?
  createdAt     DateTime @default(now())
  user          User     @relation(fields: [userId], references: [id])
}

model Package {
  id               Int               @id @default(autoincrement())
  name             String
  amount           Decimal           @db.Decimal(18, 6)
  position         Int
  isActive         Boolean           @default(true)
  createdAt        DateTime          @default(now())
  balanceTransfers BalanceTransfer[]
  userPackages     UserPackage[]
}

model UserPackage {
  id          Int       @id @default(autoincrement())
  userId      Int
  packageId   Int
  amount      Decimal   @db.Decimal(18, 6)
  isActive    Boolean   @default(true)
  startedAt   DateTime  @default(now())
  endedAt     DateTime?
  source      String
  totalEarned Decimal   @default(0) @db.Decimal(18, 6)
  lastRoiAt   DateTime?
  package     Package   @relation(fields: [packageId], references: [id])
  user        User      @relation(fields: [userId], references: [id])

  @@index([userId, isActive])
}

model Deposit {
  id                        Int                         @id @default(autoincrement())
  userId                    Int
  amount                    Decimal                     @db.Decimal(18, 6)
  trxId                     String
  status                    String                      @default("pending")
  createdAt                 DateTime                    @default(now())
  user                      User                        @relation(fields: [userId], references: [id])
  history                   DepositHistory[]
  referralCommissionHistory ReferralCommissionHistory[]
  userDepositRois           UserDepositRoi[]
  roiEarnings               RoiEarning[]
}

model DepositHistory {
  id          Int      @id @default(autoincrement())
  userId      Int
  depositId   Int
  amount      Decimal  @db.Decimal(18, 6)
  trxId       String
  status      String
  processedBy Int
  createdAt   DateTime @default(now())
  deposit     Deposit  @relation(fields: [depositId], references: [id])
  admin       Admin    @relation("AdminProcessRelation", fields: [processedBy], references: [id])
  user        User     @relation(fields: [userId], references: [id])
}

model Admin {
  id        Int              @id @default(autoincrement())
  username  String           @unique
  password  String
  createdAt DateTime         @default(now())
  processed DepositHistory[] @relation("AdminProcessRelation")
}

model ApprovedDeposit {
  id        Int      @id @default(autoincrement())
  userId    Int
  amount    Decimal  @db.Decimal(18, 6)
  trxId     String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
}

model RejectedDeposit {
  id        Int      @id @default(autoincrement())
  userId    Int
  amount    Decimal  @db.Decimal(18, 6)
  trxId     String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id])
}

model WithdrawRequest {
  id         Int       @id @default(autoincrement())
  userId     Int
  amount     Decimal   @db.Decimal(18, 6)
  commission Decimal   @default(0) @db.Decimal(18, 6)
  netAmount  Decimal   @default(0) @db.Decimal(18, 6)
  address    String
  network    String
  status     String
  approvedAt DateTime?
  rejectedAt DateTime?
  createdAt  DateTime  @default(now())
  user       User      @relation(fields: [userId], references: [id])

  @@index([status])
}

model Withdraw {
  id         Int       @id @default(autoincrement())
  userId     Int
  amount     Decimal   @db.Decimal(18, 6)
  walletType String
  status     String    @default("pending")
  createdAt  DateTime  @default(now())
  approvedAt DateTime?
  rejectedAt DateTime?
  user       User      @relation(fields: [userId], references: [id])
}

model WithdrawAddress {
  id        Int      @id @default(autoincrement())
  userId    Int      @unique
  address   String
  network   String
  createdAt DateTime @default(now())
  user      User     @relation("UserWithdrawAddress", fields: [userId], references: [id])
}

model ApprovedWithdraw {
  id         Int      @id @default(autoincrement())
  userId     Int
  amount     Decimal  @db.Decimal(18, 6)
  walletType String
  createdAt  DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id])
}

model RejectedWithdraw {
  id         Int      @id @default(autoincrement())
  userId     Int
  amount     Decimal  @db.Decimal(18, 6)
  walletType String
  createdAt  DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id])
}

model BalanceTransfer {
  id         Int      @id @default(autoincrement())
  senderId   Int
  receiverId Int
  amount     Decimal  @db.Decimal(18, 6)
  packageId  Int?
  status     String   @default("PENDING")
  createdAt  DateTime @default(now())
  package    Package? @relation(fields: [packageId], references: [id])
  receiver   User     @relation("Receiver", fields: [receiverId], references: [id])
  sender     User     @relation("Sender", fields: [senderId], references: [id])
}

model UserDepositRoi {
  id          Int      @id @default(autoincrement())
  userId      Int
  depositId   Int
  amount      Decimal  @db.Decimal(18, 6)
  roiPercent  Decimal  @default(2) @db.Decimal(5, 2)
  nextRoiTime DateTime
  active      Boolean  @default(true)
  deposit     Deposit  @relation(fields: [depositId], references: [id])
  user        User     @relation(fields: [userId], references: [id])
}

model RoiHistory {
  id           Int              @id @default(autoincrement())
  userId       Int
  earningId    Int?
  amount       Decimal          @db.Decimal(18, 6)
  createdAt    DateTime         @default(now())
  earning      RoiEarning?      @relation(fields: [earningId], references: [id])
  user         User             @relation(fields: [userId], references: [id])
  levelIncomes RoiLevelIncome[]
}

model RoiEarning {
  id           Int          @id @default(autoincrement())
  userId       Int
  depositId    Int
  amount       Decimal      @db.Decimal(18, 6)
  createdAt    DateTime     @default(now())
  nextRun      DateTime
  totalEarned  Decimal      @default(0) @db.Decimal(18, 6)
  maxEarnable  Decimal      @default(0) @db.Decimal(18, 6)
  isActive     Boolean      @default(true)
  lastRunDate  DateTime?
  roiHistories RoiHistory[]
  deposit      Deposit      @relation(fields: [depositId], references: [id])
  user         User         @relation(fields: [userId], references: [id])

  @@map("roiearning")
}

model RoiSettings {
  id            Int      @id @default(autoincrement())
  roiPercent    Decimal  @default(2) @db.Decimal(5, 2)
  capMultiplier Decimal  @default(2) @db.Decimal(5, 2)
  roiDays       String   @default("Mon,Tue,Wed,Thu,Fri")
  offDays       String   @default("Sat,Sun")
  timezone      String   @default("UTC")
  updatedAt     DateTime @updatedAt
}

model RoiLevelIncome {
  id           Int         @id @default(autoincrement())
  userId       Int
  fromUserId   Int
  roiHistoryId Int?
  source       String?
  level        Int
  amount       Decimal     @db.Decimal(18, 6)
  createdAt    DateTime    @default(now())
  fromUser     User        @relation("LevelFromUser", fields: [fromUserId], references: [id])
  roiHistory   RoiHistory? @relation(fields: [roiHistoryId], references: [id])
  user         User        @relation("LevelUser", fields: [userId], references: [id])
}

model ReferralCommissionHistory {
  id         Int      @id @default(autoincrement())
  userId     Int
  fromUserId Int
  depositId  Int?
  level      Int
  commission Decimal  @db.Decimal(18, 6)
  createdAt  DateTime @default(now())
  deposit    Deposit? @relation(fields: [depositId], references: [id])
  fromUser   User     @relation("ReferralFromUser", fields: [fromUserId], references: [id])
  user       User     @relation("ReferralToUser", fields: [userId], references: [id])
}
